--- package/lean/default-settings/files/zzz-default-settings	2022-10-03 02:12:01.386585160 +0800	2022-10-05 12:45:55.437999379 +0800
+++ package/lean/default-settings/files/zzz-default-settings	2022-10-03 02:12:01.386585160 +0800	2022-10-05 12:50:14.527999280 +0800
@@ -39,10 +39,27 @@ sed -i '/openwrt_luci/ { s/snapshots/rel
 if [ $(sed -n '/^# automatically generated by default-settings on the first boot/p' /etc/firewall.user) == '' ]; then
 	echo -n '
 # automatically generated by default-settings on the first boot
-iptables -t nat -A PREROUTING -p udp --dport 53 -j REDIRECT --to-ports 53
-iptables -t nat -A PREROUTING -p tcp --dport 53 -j REDIRECT --to-ports 53
-[ -n "$(command -v ip6tables)" ] && ip6tables -t nat -A PREROUTING -p udp --dport 53 -j REDIRECT --to-ports 53
-[ -n "$(command -v ip6tables)" ] && ip6tables -t nat -A PREROUTING -p tcp --dport 53 -j REDIRECT --to-ports 53
+ipset -N bplan hash:net 2>/dev/null
+ipset -N bplanmac hash:mac 2>/dev/null
+#ipset -N whitelist hash:net 2>/dev/null
+#ipset -N china hash:net 2>/dev/null
+iptables -t filter -A forwarding_lan_rule -m set --match-set bplan src -j RETURN
+#iptables -t filter -A forwarding_lan_rule -o eth1 -p udp -m multiport --dport 80,443 -m set --match-set whitelist dst -j RETURN
+#iptables -t filter -A forwarding_lan_rule -o eth1 -p udp -m multiport --dport 80,443 -m set ! --match-set china dst -j REJECT
+#iptables -t filter -A forwarding_lan_rule -p tcp -d 1.1.1.1 --dport 443 -j REJECT --reject-with tcp-reset
+#iptables -t filter -A forwarding_lan_rule -p tcp -d 8.8.8.8 --dport 443 -j REJECT --reject-with tcp-reset
+
+iptables -t nat -A PREROUTING -p udp -d $(dig +short A OpenWrt.lan) --dport 53 -m set --match-set bplan src -j REDIRECT --to-ports 534
+iptables -t nat -A PREROUTING -p tcp -d $(dig +short A OpenWrt.lan) --dport 53 -m set --match-set bplan src -j REDIRECT --to-ports 534
+iptables -t nat -A PREROUTING -p udp -d 192.168.0.0/16 --dport 53 -j RETURN
+iptables -t nat -A PREROUTING -p tcp -d 192.168.0.0/16 --dport 53 -j RETURN
+iptables -t nat -A PREROUTING -p udp -m set ! --match-set bplan src --dport 53 -j REDIRECT --to-ports 53
+iptables -t nat -A PREROUTING -p tcp -m set ! --match-set bplan src --dport 53 -j REDIRECT --to-ports 53
+
+[ -n "$(command -v ip6tables)" ] && ip6tables -t nat -A PREROUTING -p udp -d FC00::/7 --dport 53 -j RETURN
+[ -n "$(command -v ip6tables)" ] && ip6tables -t nat -A PREROUTING -p tcp -d FC00::/7 --dport 53 -j RETURN
+[ -n "$(command -v ip6tables)" ] && ip6tables -t nat -A PREROUTING -p udp --dport 53 -m set ! --match-set bplanmac src -j REDIRECT --to-ports 53
+[ -n "$(command -v ip6tables)" ] && ip6tables -t nat -A PREROUTING -p tcp --dport 53 -m set ! --match-set bplanmac src -j REDIRECT --to-ports 53
 ' >> /etc/firewall.user
 fi
 
